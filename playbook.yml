- name: Crear VM en GCP e instalar Jenkins
  hosts: localhost
  connection: local
  gather_facts: no
  vars:
    project_id: "{{ lookup('env','GCP_PROJECT_ID') }}"
    zone: "{{ lookup('env','GCP_ZONE') }}"
    instance_name: "jenkins-vm"
    machine_type: "e2-micro"  # or "f1-micro" if preferred
    image_family: "debian-11"  # Linux image in GCP
  tasks:
    - name: Crear instancia en GCP (Linux)
      gcp_compute_instance:
        name: "{{ instance_name }}"
        machine_type: "{{ machine_type }}"
        zone: "{{ zone }}"
        project: "{{ project_id }}"
        auth_kind: serviceaccount
        service_account_file: "/tmp/gcloud_service_account.json"
        disks:
          - auto_delete: true
            boot: true
            initialize_params:
              source_image: "projects/debian-cloud/global/images/family/{{ image_family }}"
        scopes:
          - "https://www.googleapis.com/auth/cloud-platform"
        metadata: {}
        network_interfaces:
          - network:
              name: "global/networks/default"
            access_configs:
              - name: "External NAT"
                type: "ONE_TO_ONE_NAT"
      register: vm_info

    - name: Esperar a que la instancia esté en estado RUNNING
      pause:
        seconds: 1

    - name: Obtener IP de la instancia usando gcloud CLI
      shell: |
        gcloud auth activate-service-account --key-file=/tmp/gcloud_service_account.json
        gcloud compute instances describe {{ instance_name }} --zone={{ zone }} --project={{ project_id }} --format="get(networkInterfaces[0].accessConfigs[0].natIP)"
      register: instance_ip

    - name: Agregar la instancia creada al inventario dinámico
      add_host:
        name: jenkins-vm
        ansible_host: "{{ instance_ip.stdout }}"
        ansible_user: "alfonso_cloud_eng"

- name: Configurar Jenkins en la VM (Linux)
  hosts: jenkins-vm
  become: yes
  gather_facts: yes
  vars:
    ansible_ssh_user: "alfonso_cloud_eng"  # Replace with your actual SSH username on the VM
    job_name: "my_jenkins_job"             # Customize the Jenkins job name as needed
  tasks:
    - name: Actualizar repositorios APT
      apt:
        update_cache: yes

    - name: Instalar dependencias necesarias (Java, wget, python3, python3-pip)
      apt:
        name:
          - openjdk-11-jdk
          - wget
          - python3
          - python3-pip
        state: present

    - name: Instalar Jenkins (using official repository)
      shell: |
        curl -fsSL https://pkg.jenkins.io/debian-stable/jenkins.io.key | sudo apt-key add -
        sudo sh -c 'echo deb https://pkg.jenkins.io/debian-stable binary/ > /etc/apt/sources.list.d/jenkins.list'
        sudo apt-get update
        sudo apt-get install -y jenkins
      args:
        executable: /bin/bash

    - name: Iniciar Jenkins y habilitar arranque automático
      service:
        name: jenkins
        state: started
        enabled: yes

    - name: Crear directorio para el proyecto
      file:
        path: /home/{{ ansible_ssh_user }}/myapp
        state: directory

    - name: Descargar main.py desde repositorio público de GitHub
      shell: |
        cd /home/{{ ansible_ssh_user }}/myapp
        wget https://raw.githubusercontent.com/alfonso-cloud-eng/python-automation-gitlab-jenkins-ansible/main/main.py -O main.py
      args:
        executable: /bin/bash

    - name: Descargar Jenkinsfile desde repositorio público de GitHub
      shell: |
        cd /home/{{ ansible_ssh_user }}/myapp
        wget https://raw.githubusercontent.com/alfonso-cloud-eng/python-automation-gitlab-jenkins-ansible/main/Jenkinsfile -O Jenkinsfile
      args:
        executable: /bin/bash

    # --- Steps to create the Jenkins job automatically ---
    - name: Copiar plantilla para configuración del job en Jenkins
      copy:
        dest: /tmp/job_config.xml.j2
        content: |
          <?xml version='1.1' encoding='UTF-8'?>
          <flow-definition plugin="workflow-job@2.40">
            <actions/>
            <description>Job creado automáticamente</description>
            <keepDependencies>false</keepDependencies>
            <properties/>
            <definition class="org.jenkinsci.plugins.workflow.cps.CpsFlowDefinition" plugin="workflow-cps@2.92">
              <!-- Insert the Jenkinsfile content, escaped for XML -->
              <script>{{ jenkinsfile_content | xml_escape }}</script>
              <sandbox>true</sandbox>
            </definition>
            <triggers/>
            <disabled>false</disabled>
          </flow-definition>
    
    - name: Leer contenido del Jenkinsfile
      slurp:
        src: /home/{{ ansible_ssh_user }}/myapp/Jenkinsfile
      register: jenkinsfile_raw

    - name: Decodificar contenido del Jenkinsfile
      set_fact:
        jenkinsfile_content: "{{ jenkinsfile_raw.content | b64decode }}"

    - name: Renderizar configuración del job en Jenkins
      template:
        src: /tmp/job_config.xml.j2
        dest: /tmp/job_config.xml
      vars:
        jenkinsfile_content: "{{ jenkinsfile_content }}"

    - name: Crear job pipeline en Jenkins
      shell: |
        # Obtener crumb de Jenkins (asumiendo que CSRF está activado)
        CRUMB=$(curl -s 'http://localhost:8080/crumbIssuer/api/xml?xpath=concat(//crumbRequestField,":",//crumb)')
        # Llamar a la API de Jenkins para crear el job usando la configuración XML generada
        curl -X POST "http://localhost:8080/createItem?name={{ job_name }}" \
          -H "$CRUMB" \
          -H "Content-Type: application/xml" \
          --data-binary @/tmp/job_config.xml
      args:
        executable: /bin/bash
